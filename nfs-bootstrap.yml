---

- name: Bootstrap Kubernetes Persistent Volume Store
  become: true
  hosts: all
  vars:
    kube_prefix: kube-
    nfs_hostname: "{{ kube_prefix }}nfs"
    nfs_opts: "rw,sync,no_root_squash,no_subtree_check"
    storage_id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
  tasks:
    - name: Ensure NFS IP address fact is defined
      set_fact:
        nfs_addr: "{{ hostvars[nfs_hostname].ansible_eth1.ipv4.address }}"
        node_subnet: "{{ hostvars[nfs_hostname].ansible_eth1.ipv4.address[:-4] }}"

    - name: Ensure hostname of master is correct
      hostname:
        name: "{{ nfs_hostname }}"

    - name: Ensure hostnames are in /etc/hosts
      lineinfile:
        line: "{{ item }}"
        path: /etc/hosts
        state: present
      with_items:
        - "{{ node_subnet }}.2 {{ kube_prefix }}0 {{ kube_prefix }}0-master"
        - "{{ node_subnet }}.3 {{ kube_prefix }}1 {{ kube_prefix }}1-worker"
        - "{{ node_subnet }}.4 {{ kube_prefix }}2 {{ kube_prefix }}2-worker"
        - "{{ node_subnet }}.5 {{ kube_prefix }}3 {{ kube_prefix }}3-worker"
        - "{{ node_subnet }}.6 {{ kube_prefix }}4 {{ kube_prefix }}4-worker"
        - "{{ node_subnet }}.7 {{ kube_prefix }}5 {{ kube_prefix }}5-worker"
        - "{{ node_subnet }}.8 {{ kube_prefix }}6 {{ kube_prefix }}6-worker"
        - "{{ node_subnet }}.9 {{ kube_prefix }}7 {{ kube_prefix }}7-worker"
        - "{{ node_subnet }}.254 {{ kube_prefix }}nfs"

    - name: Ensure firewalld service stopped and disabled
      service:
        name: firewalld
        state: stopped
        enabled: false

    - name: Ensure swap is not activated on boot
      mount:
        name: swap
        fstype: swap
        state: absent

    - name: Ensure swap is disabled
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Ensure SELinux is disabled
      selinux:
        state: disabled
      register: selinux_task

    - name: Reboot system to ensure SELinux disabled
      shell: sleep 10 && /sbin/shutdown -r now
      async: 300
      poll: 0
      ignore_errors: true
      when: selinux_task.changed == true

    - name: Wait for system to become reachable again
      wait_for_connection:
        delay: 60
        timeout: 300
      when: selinux_task.changed == true

    - name: Ensure epel-release installed
      yum:
        name: epel-release
        state: present
        update_cache: true

    - name: Ensure nfs utils installed
      yum:
        name: nfs-utils
        state: present
        update_cache: true
      notify:
        - restart nfs

    - name: Ensure storage directory exists
      file:
        path: "/kube"
        state: directory

    - name: Ensure NFS directories exist
      file:
        path: "/kube/store{{ item }}"
        state: directory
      with_items: "{{ storage_id }}"

    - name: Ensure NFS exports are defined
      lineinfile:
        line: "/kube/store{{ item[0] }} {{ node_subnet }}.{{ item[1] }}({{ nfs_opts }})"
        path: /etc/exports
      with_nested: 
        - "{{ storage_id }}"
        - [2, 3, 4, 5, 6, 7, 8, 9]
      notify:
        - restart nfs

  handlers:
    - name: restart nfs
      service:
        name: nfs-server
        state: restarted
        enabled: true
