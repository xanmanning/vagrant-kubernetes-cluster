# GitLab on Kubernetes w. Consul + Vault

## Requirements

  - kubectl
  - cfssl + cfssljson

## TLS Certs

cfssl gencert -initca ca/ca-csr.json | cfssljson -bare ca

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca/ca-config.json \
  -profile=default \
  ca/consul-csr.json | cfssljson -bare consul

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca/ca-config.json \
  -profile=default \
  ca/vault-csr.json | cfssljson -bare vault 

GOSSIP_ENCRYPTION_KEY=$(consul keygen)

kubectl create secret generic consul \
  --from-literal="gossip-encryption-key=${GOSSIP_ENCRYPTION_KEY}" \
  --from-file=ca.pem \
  --from-file=consul.pem \
  --from-file=consul-key.pem

kubectl create configmap consul --from-file=configs/consul.json

kubectl create -f services/consul.yaml

kubectl create -f serviceaccounts/consul.yaml

kubectl create -f clusterroles/consul.yaml

kubectl create -f statefulsets/consul.yaml

kubectl create secret generic vault \
    --from-file=ca.pem \
    --from-file=vault.pem \
    --from-file=vault-key.pem

kubectl create configmap vault --from-file=configs/vault.json
kubectl create -f services/vault.yaml
kubectl create -f serviceaccounts/vault.yaml
kubectl create -f statefulsets/vault.yaml
#kubectl create -f deployments/vault.yaml
